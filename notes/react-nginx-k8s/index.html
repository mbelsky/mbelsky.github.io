<!DOCTYPE html>
<html lang="en-us">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>Serve React applicaiton with Nginx in k8s | Max Belsky â€” a software developer and music lover</title>
<meta name="description" content="" />



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<link rel="stylesheet" href="/css/reset.css">
<link rel="stylesheet" href="/css/styles.css">


<meta property="og:title" content="Serve React applicaiton with Nginx in k8s" />
<meta property="og:description" content="A few things I&rsquo;ve learned after deploying React application &#43; nginx in Kubernetes.
nobody user To run a process as non-root you don&rsquo;t need create a user in your docker image. Just use the nobody:
docker run --user=&#34;nobody&#34; nginx read-only container To succesfully run a read only container with nginx don&rsquo;t forget to pass some volumes:
docker run --read-only --tmpfs &#34;/var/cache/nginx&#34; --tmpfs &#34;/run&#34; --rm nginx-react-app In k8s add volumes and use them as the container&rsquo;s volumeMounts." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.mbelsky.com/notes/react-nginx-k8s/" /><meta property="article:section" content="notes" />
<meta property="article:published_time" content="2021-02-28T16:26:02+03:00" />
<meta property="article:modified_time" content="2021-02-28T16:26:02+03:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Serve React applicaiton with Nginx in k8s"/>
<meta name="twitter:description" content="A few things I&rsquo;ve learned after deploying React application &#43; nginx in Kubernetes.
nobody user To run a process as non-root you don&rsquo;t need create a user in your docker image. Just use the nobody:
docker run --user=&#34;nobody&#34; nginx read-only container To succesfully run a read only container with nginx don&rsquo;t forget to pass some volumes:
docker run --read-only --tmpfs &#34;/var/cache/nginx&#34; --tmpfs &#34;/run&#34; --rm nginx-react-app In k8s add volumes and use them as the container&rsquo;s volumeMounts."/>



<body>
    <div id="content">
<header class="single__header">
  <h1 class="single__title__h1">Serve React applicaiton with Nginx in k8s</h1>
  <time
    class="single__time"
    datetime=2021-02-28>Feb 28, 2021</time>
</header>
<main class="single__main"><p>A few things I&rsquo;ve learned after deploying React application + nginx in Kubernetes.</p>
<h2 id="nobody-user"><code>nobody</code> user</h2>
<p>To run a process as non-root you don&rsquo;t need create a user in your docker image. Just use the <code>nobody</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run --user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nobody&#34;</span>
</code></pre></div><h2 id="nginx-read-only-container">nginx read-only container</h2>
<p>To succesfully run a read only container with nginx don&rsquo;t forget to pass some volumes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run --read-only --tmpfs <span style="color:#e6db74">&#34;/var/cache/nginx&#34;</span> --tmpfs <span style="color:#e6db74">&#34;/run&#34;</span> --rm nginx-react-app
</code></pre></div><p>In k8s add <code>volumes</code> and use them as the container&rsquo;s <code>volumeMounts</code>.</p>
<h2 id="nginxconf">nginx.conf</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">events</span> {}

<span style="color:#66d9ef">http</span> {
  <span style="color:#f92672">server</span> {
    <span style="color:#75715e"># non-root user can&#39;t listen 80 port
</span><span style="color:#75715e"></span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">8080</span>;
    <span style="color:#f92672">root</span> <span style="color:#e6db74">/usr/share/nginx/html</span>;

    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
      <span style="color:#75715e"># tricky location here because the app works on example.com/PATH_TO_THE_APP/
</span><span style="color:#75715e"></span>      <span style="color:#f92672">location</span> ~ <span style="color:#e6db74">.*/(\w+\.\w+).js(.map)?$</span> {
        <span style="color:#f92672">try_files</span> $uri <span style="color:#e6db74">/</span>$1.js$2;
      }

      <span style="color:#f92672">try_files</span> $uri <span style="color:#e6db74">/index.html</span>;
    }
  }
}
</code></pre></div><h2 id="dockerfile">Dockerfile</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node:14.15 as build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;package.json&#34;</span>, <span style="color:#e6db74">&#34;yarn.lock&#34;</span>, <span style="color:#e6db74">&#34;./&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> yarn install --frozen-lockfile --production<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># rm nginx.conf to make layers work</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm nginx.conf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#75715e"># The app should be bundled with webpack&#39;s HtmlWebpackPlugin.publicPath = &#39;auto&#39;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#f92672">&amp;&amp;</span> yarn build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> nginx:1.19</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> nginx.conf /etc/nginx/nginx.conf<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>build /app/dist /usr/share/nginx/html<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;nginx&#34;</span>, <span style="color:#e6db74">&#34;-g&#34;</span>, <span style="color:#e6db74">&#34;daemon off;&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div></main>
</div>
    <footer>
  <hr>
  <div class="footer__links">
    <a href="/">Home</a>
  </div>
  <span class="footer__license">
    All code in this site is licensed under the MIT
    license. All other content is licensed under the
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
    license.</span>
</footer>
</body>
</html>